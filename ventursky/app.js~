var app=require("express")();
var bodyParser=require("body-parser");
var mongoose=require('mongoose');
mongoose.connect('mongodb://localhost/myDatabase');
var UserSchema=new mongoose.Schema({
									Id 			: String,
									Name 			: String,
									Address 		: String,
									Phone 			: Number,
									Adhar_id		: Number,
									Pan_id			: String,
									Battery_Id 		: String,
									isAvailable		: Boolean,
									Balance 		: Number
								  });

var User = mongoose.model("User",UserSchema);
app.use(bodyParser.urlencoded({extended: true}));
var methodOverride = require("method-override");
app.use(methodOverride("_method"));

app.get("/",function(req,res){
	res.render("form.ejs");
});


app.post("/form_submit",function(req,res){
var user_id         = req.body.user_id;
var user_name       = req.body.user_name;
var user_address    = req.body.user_address;
var user_phone      = req.body.user_phone;
var user_adharId    = req.body.user_adharId;
var user_panId      = req.body.user_panId;
var user_battery_id = req.body.user_battery_id;
var newUser =       {
						Id 				: user_id,
						Name 			: user_name,
						Address 		: user_address,
						Phone 			: user_phone,
						Adhar_id 		: user_adharId,
						Pan_id 			: user_panId,
						Battery_Id 		: user_battery_id,
						isAvailable		: false,
						Balance 		: 0
					}
	User.create(newUser,function(err,value){
										if (err)
											console.log(err);
										else
											{
												console.log (value);
												res.redirect('/');
											}
	 								});
});
app.get("/checkUser/:rfid/:batteryid",function(req,res){
				User.find({ Id : rfid } , function(err,valid_user){
						if (err)
							console.log(err);
						else
							{
								console.log(valid_user);
							}
				});
});

app.get("/update/:rfid",function(req,res){
	var rfid = req.params.rfid;
	User.updateOne({ Id : rfid }, {$set: { "Battery_Id": "1" },{"isAvailable" : false}})
			.then(function(result) {
			  	if (result)
			  		console.log(result);
				});



app.get('/charged/:rfid',function(req,res){
	var rfid = req.params.rfid;
	User.updateOne({Id : rfid},{$set: {"isAvailable" : true}}).then(function(result){
		if (result)
		{
			console.log(result);
			console.log("Battery is Available");			
		}
	});
});



app.listen(4040,function(){
	console.log("Server Started");
});
